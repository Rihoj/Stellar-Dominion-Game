<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html/public
    
    # Enable mod_rewrite
    RewriteEngine On
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # Directory configuration
    <Directory /var/www/html/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Front controller pattern - route everything through index.php
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]
    </Directory>
    
    # Deny access to sensitive files and directories
    <DirectoryMatch "/(config|src|template|vendor|logs|docker)">
        Require all denied
    </DirectoryMatch>
    
    <Files "composer.json">
        Require all denied
    </Files>
    
    <Files "composer.lock">
        Require all denied
    </Files>
    
    <Files ".env">
        Require all denied
    </Files>
    
    # Configure uploads directory
    <Directory /var/www/html/public/uploads>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Only allow image files
        <FilesMatch "\.(jpg|jpeg|png|gif)$">
            Require all granted
        </FilesMatch>
        
        # Deny everything else
        <FilesMatch "\.(?!(jpg|jpeg|png|gif)$)[^.]+$">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Logging
    ErrorLog /var/log/apache2/stellar_dominion_error.log
    CustomLog /var/log/apache2/stellar_dominion_access.log combined
    LogLevel warn
</VirtualHost>
